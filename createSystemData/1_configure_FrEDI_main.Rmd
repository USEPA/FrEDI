---
title: "Configure Main FrEDI Data"
author: "Industrial Economics, Inc."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_document:
    theme: spacelab
    toc: true
    toc_float: true
---

<style>
/* Simplified version of Bootstrap's responsive table CSS */
.table-responsive {
display: block;
width: 100%;
overflow-x: auto;
}

.table-responsive > table {
width: 100%;
}
</style>


```{r knitr setup, include=FALSE}
### The following parameters declare the options for compiling the Markdown document.
knitr::opts_chunk$set(
  include = T,     ### Evaluate and depict outputs of code chunks in the compiled document
  echo    = T,     ### Echo the commands of the code chunks in the compiled document
  message = FALSE, ### Don't include command-line messages output from evaluating code chunks
  cache   = FALSE, ### Don't cache the evaluation of code chunks
  warning = FALSE,  ### Don't include warnings from evaluating code chunks
  table.format = "html" 
)
```

## Overview

The purpose of this package is to configure the data for the main FrEDI tool. 

Load packages 

```{r loadPackages}
### Packages
require(tidyverse)
require(openxlsx)
require(devtools)
```


Date of most recent version of the Excel configuration file:

```{r mostRecentDate}
mostRecentDate <- "20221025"
```



```{r declare paths}
### Set print options
# options(digits = 20)
### Set system paths
# projectPath      <- getwd()
projectPath      <- "."
today            <- format(Sys.Date(), "%Y%m%d")

### Path to fredi project
projectParentDir <- projectPath %>% file.path("..")
projectParentDir %>% list.files
frediPath        <- projectParentDir %>% file.path("FrEDI")

### Project configuration
configPath       <- projectPath %>% file.path("config")
# configFiles      <- configPath %>% list.files(".R")
configFiles      <- "frediConfig.R"
### Code path
codePath         <- projectPath %>% file.path("R")
codeNames        <- codePath %>% list.files(".R")
configLogPath    <- codePath %>% file.path("configLog")

### Names for archive and use versions
configFileName   <- "fredi_config"
configArchName   <- configLogPath %>% file.path(configFileName) %>% paste(today, sep="_") %>% paste0(".rda")
configUseName    <- codePath %>% file.path(configFileName) %>% paste0(".rda")

### Output path
dataOutPath      <- projectPath %>% file.path("data")
dataOutLog       <- dataOutPath %>% file.path("dataLog")
sysFileName      <- "sysdata"
sysArchName      <- dataOutLog %>% file.path(sysFileName) %>% paste(today, sep="_") %>% paste0(".rda")
excelFileName    <- mostRecentDate %>% paste("FrEDI_config.xlsx", sep="_")
sysUseName       <- dataOutPath %>% file.path(sysFileName) %>% paste0(".rda")
```

### Configuration Files

Load all configuration functions

```{r load config}
### Load all functions
configFiles; for(i in configFiles){ source(paste(configPath, i, sep="/")) }
```


List configuration files

```{r}
configLogPath %>% list.files("rda") %>% sort(decreasing=FALSE) %>% head
```

Update archive:

```{r}
frediConfig(outPath = configArchName)
```

Confirm copy was saved:

```{r}
basename(configArchName) %in% (configLogPath %>% list.files("rda"))
```

## Create Tool Configuration Data


Load all R functions and configuration files

```{r load code}
### Load all functions
codeNames; for(i in codeNames){ source(paste(codePath, i, sep="/")) }
```

Test system data

```{r test_systemData0}
codeNames; for(i in codeNames){ source(paste(codePath, i, sep="/")) }
frediPath %>% load_all
### Uncomment following two lines to create and save data and check the outputs
time1           <- Sys.time()
test_systemData <- createSystemData(save=F, excelName = excelFileName, silent=T)
time2           <- Sys.time()
time_create     <- time2 - time1; time_create
```


## Check Outputs


Use the following code chunks to view/check outputs for the new sector (all data stored in a list called `test_systemData`)

### Scalars


```{r test_scalars}
### test_scalars: dataframe with configuration values for scalars 
test_scalars <- test_systemData$scalarDataframe
test_scalars %>% glimpse
### test_mainScalars: dataframe with annual values for scalars 
test_mainScalars <- test_systemData$df_mainScalars
test_mainScalars$scalarType %>% unique
(test_mainScalars %>% filter(scalarType=="econScalar"))$scalarName %>% unique
test_mainScalars %>% glimpse
# test_mainScalars_sum <- test_mainScalars %>% group_by_at(.vars=c(""))
### test_mainScalars: dataframe with info about scalars
test_scalarInfo <- test_systemData$co_scalarInfo
test_scalarInfo %>% glimpse

### test_sectorsInfo: dataframe with info about sectors and scalars
test_sectorsInfo <- test_systemData$df_sectorsInfo
test_sectorsInfo %>% glimpse

test_sectorsInfo %>% filter(sector=="Rail") %>% glimpse
### Initial results
test_systemData$df_results0 %>% glimpse
```




### Check SLR Outputs

#### SLR Drivers 



SLR drivers should have no missing values past 2090 and only one row for each `year~model` combo:

```{r test_slr_cm}
# fun_slrModel2Height <- utils::getFromNamespace("fun_slrModel2Height", "FrEDI")
test_slr_cm <- test_systemData$slr_cm %>% 
  mutate(model_fact = model_dot %>% fun_slrModel2Height(include="values", valType="factor",labelType="character"))
test_slr_cm %>% glimpse
test_slr_cm %>% filter(year > 2090) %>% filter(is.na(driverValue)) %>% nrow
test_slr_cm %>% mutate(n=1) %>% group_by_at(.vars=c("year", "model")) %>% summarize_at(.vars=c("n"), sum) %>% filter(n>1) %>% nrow
```

Visual check of drivers 

```{r, fig.width=6, fig.height=4}
test_slr_cm %>% ggplot() + geom_line(aes(x=year, y=driverValue, color = model_fact))
```

#### SLR Scaled Impacts

SLR scaled impacts should have no missing values past 2090 and only one row for each `year~sector~variant~impactType~impactYear~region~model` combo:


```{r test_imp_cm}
test_imp_cm <- test_systemData$slrImpacts %>% 
  mutate(model_fact = model_dot %>% fun_slrModel2Height(include="values", valType="factor",labelType="character"))
test_imp_cm %>% glimpse
test_imp_cm %>% filter(year > 2090) %>% filter(is.na(scaled_impacts)) %>% nrow
test_imp_cm %>% mutate(n=1) %>% group_by_at(.vars=c("year", "sector", "variant", "impactType", "impactYear", "region", "model")) %>% summarize_at(.vars=c("n"), sum) %>% filter(n>1) %>% nrow
```

Visual check of scaled impacts 

```{r, fig.width=9, fig.height=5}
plots_imp_cm <- test_imp_cm %>% 
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      ### Filter data
      data_i <- data_x %>% filter(sector==sector_i)
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Adjust data
      lim_i  <- data_i$scaled_impact %>% min(na.rm=T) %>% c(data_i$scaled_impact %>% max(na.rm=T))
      rng_i  <- lim_i[2] - lim_i[1]
      # c(lim_i) %>% print
      ### Log
      log_i  <- rng_i %>% log10 %>% floor %>% as.integer
      ord_i  <- (log_i %/% 3) %>% floor %>% as.integer
      div_i  <- (10e3)^ord_i
      # c(rng_i, log_i, ord_i) %>% print
      ### Scale limits
      lim2_i <- c(floor(round(lim_i[1] / div_i, 3)), round(lim_i[2] / div_i, 3))
      rng2_i <- (lim2_i[2] - lim2_i[1])
      log2_i <-  rng2_i %>% log10 %>% floor %>% as.integer
      c(lim2_i, rng2_i, log2_i) %>% print
      ###
      adj_i  <- ifelse(log2_i<0, -1, 1) %>% as.integer
      adj2_i <- (adj_i*log2_i + 1)      %>% as.integer
      adj3_i <- (10^as.integer(adj2_i)) %>% as.integer
      c(adj_i, adj2_i, adj2_i) %>% print
      ### Steps
      stp1_i <- (rng2_i / 5)*10^adj2_i
      stp2_i <- stp1_i %>% ceiling
      stp3_i <- stp2_i / 10^(adj2_i + 0)
      
      c(stp1_i, stp2_i, stp3_i) %>% print
      ### Labs and breaks
      yLab_i <- c("thousands", "millions", "billions")[ord_i]
      brk_i  <- seq(lim2_i[1], lim2_i[2], by = stp3_i) %>% round(2)
      lab_i  <- brk_i %>% as.character
      c(yLab_i) %>% print; c(brk_i) %>% print; c(lab_i) %>% print
      data_i <- data_i %>% mutate(scaled_impacts=scaled_impacts/div_i)
      data_i <- data_i %>% mutate(scaled_impacts=scaled_impacts %>% round(6))
      #### Plot data
      plot_i <- data_i %>% ggplot() +
        geom_line(aes(x=year, y=scaled_impacts, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~model_fact)
      plot_i <- plot_i +
        theme(legend.position = "bottom") +
        theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(sector_i)
      plot_i <- plot_i + scale_y_continuous(yLab_i, breaks = brk_i, labels=lab_i)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_imp_cm[[1]]
```


#### SLR Scaled Extremes



```{r}
frediPath %>% load_all
test_ext_cm <- fun_slrConfigExtremes(
    slr_x = test_systemData$slr_cm,    ### rDataList$slr_cm
    imp_x = test_systemData$slrImpacts ### rDataList$slrImpacts
  )
# test_ext_cm %>% filter(driverValue2 < driverValue1) %>% nrow
# test_ext_cm %>% filter(driverValue2 == driverValue1) %>% nrow
# test_ext_cm %>% filter(is.na(driverValue)) %>% nrow
test_ext_cm %>% filter(impacts_intercept < 0) %>% nrow
test_ext_cm %>% filter(impacts_slope < 0) %>% nrow
test_ext_cm %>% glimpse
```


SLR scaled impacts should have no missing values past 2090 and only one row for each `year~sector~variant~impactType~impactYear~region~model` combo:


```{r test_ext_cm}
# frediPath %>% load_all
test_ext_cm <- test_systemData$slrExtremes #%>% mutate(model_fact = model_dot %>% fun_slrModel2Height(include="values", valType="factor",labelType="character"))
test_ext_cm %>% glimpse
test_ext_cm %>% filter(impacts_intercept < 0) %>% nrow
test_ext_cm %>% filter(impacts_slope < 0) %>% nrow
test_ext_cm %>% filter(year > 2090) %>% filter(is.na(impacts_slope)) %>% nrow
test_ext_cm %>% mutate(n=1) %>% group_by_at(.vars=c("year", "sector", "variant", "impactType", "impactYear", "region")) %>% summarize_at(.vars=c("n"), sum) %>% filter(n>1) %>% nrow
```


Check values

```{r}
test_ext_cm %>% filter(impacts_slope < 0) %>% nrow
```



Function to get breaks and limits

```{r get_plotBreaks}
get_plotBreaks  <- function(col_x){
  lim_i  <- col_x %>% range(na.rm=T)
  rng_i  <- lim_i[2] - lim_i[1]
  # c(lim_i) %>% print
  ### Log
  log_i  <- rng_i %>% log10 %>% floor %>% as.integer
  ord_i  <- (log_i %/% 3) %>% floor %>% as.integer
  div_i  <- (10e3)^ord_i
  # c(rng_i, log_i, ord_i) %>% print
  ### Scale limits
  lim2_i <- c(floor(round(lim_i[1] / div_i, 3)), round(lim_i[2] / div_i, 3))
  rng2_i <- (lim2_i[2] - lim2_i[1])
  log2_i <-  rng2_i %>% log10 %>% floor %>% as.integer
  # c(lim2_i, rng2_i, log2_i) %>% print
  
  ### Adjustment
  # adj_i  <- ifelse(log2_i<0, -1, 1) %>% as.integer
  adj2_i <- (abs(log2_i) + 1)       %>% as.integer
  adj3_i <- (10^as.integer(adj2_i)) %>% as.integer
  # c(adj_i, adj2_i, adj2_i) %>% print
  
  ### Steps
  stp1_i <- (rng2_i / 5)*10^adj2_i
  stp2_i <- stp1_i %>% ceiling
  stp3_i <- stp2_i / 10^(adj2_i + 0)
  # c(stp1_i, stp2_i, stp3_i) %>% print
  ### Labs and breaks
  yLab_i <- c("Thousands", "Millions", "Billions")[ord_i]
  brk_i  <- seq(lim2_i[1], lim2_i[2], by = stp3_i) %>% round(2)
  lab_i  <- brk_i %>% as.character
  # c(yLab_i) %>% print; c(brk_i) %>% print; c(lab_i) %>% print
  ### Return x
  return_x <- list(
    div    = div_i, 
    yLab   = yLab_i, 
    limits = lim_i / div_i, 
    breaks = brk_i, 
    labels = lab_i
  )
  return(return_x)
}
```


Visual check of impacts

```{r plots_ext_imp, fig.width=6, fig.height=4}
plots_ext_imp <- test_ext_cm %>% 
  mutate(impact = impacts_intercept + impacts_slope * driverValue_ref) %>% 
  mutate(value = impact) %>%
  # filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Values"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      # ySub   <- "SLR Impact Slopes"
      ## Filter data
      # data_i <- data_x
      data_i <- data_x %>% filter(sector==sector_i)
      data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      list_i %>% print
      # list_i[c("breaks", "labels")] %>% lapply(function(y){length(y)}) %>% unlist %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=year, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      # plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      plot_i <- plot_i + scale_y_continuous()
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_ext_imp
```



Visual check of extreme impact driver values



```{r plots_ext_cm, fig.width=6, fig.height=4}
plots_ext_cm <- test_ext_cm %>% 
  mutate(value = driverValue_ref) %>%
  group_by_at(.vars=c("year")) %>% summarize_at(.vars = c("value"), mean) %>% 
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "Maximum Driver Value"){
    # sectors_x <- data_x$sector %>% unique
    # list_x    <- sectors_x %>% lapply(function(sector_i){
      ### Standardize value column
      # data_x <- data_x %>% mutate(value = driverValue_ref)
      # ySub   <- "Maximum Driver Value"
      ### Filter data
    data_i <- data_x
      # data_i <- data_x %>% filter(sector==sector_i)
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      list_i %>% print
      # list_i[c("breaks", "labels")] %>% lapply(function(y){length(y)}) %>% unlist %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() +geom_line(aes(x=year, y=value), alpha = 0.4)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    # })
    # names(list_x) <- sectors_x
    # return(list_x)
  })
plots_ext_cm
```


Visual check of intercepts

```{r plots_ext_int, fig.width=6, fig.height=4}
plots_ext_int <- test_ext_cm %>% 
  mutate(value = impacts_intercept) %>%
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Intercepts"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      ySub   <- "SLR Impact Intercepts"
      ## Filter data
      data_i <- data_x %>% filter(sector==sector_i)
      # data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      # list_i %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=year, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_ext_int
```


Visual check of slopes

```{r plots_ext_slope, fig.width=6, fig.height=4}
plots_ext_slope <- test_ext_cm %>% 
  mutate(value = impacts_slope) %>%
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Slope"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      ySub   <- "SLR Impact Slope"
      ## Filter data
      # data_i <- data_x
      data_i <- data_x %>% filter(sector==sector_i)
      data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      # list_i %>% print
      # list_i[c("breaks", "labels")] %>% lapply(function(y){length(y)}) %>% unlist %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=year, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_ext_slope
```



Visual check of intercepts versus driver value

```{r, fig.width=6, fig.height=4}
plots_ext_slope <- test_ext_cm %>% 
  mutate(value = impacts_slope) %>%
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Slopes"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      # ySub   <- "SLR Impact Slopes"
      ## Filter data
      data_i <- data_x %>% filter(sector==sector_i)
      # data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      # list_i %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=driverValue_ref, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_ext_slope
```


Visual check of slopes

```{r, fig.width=6, fig.height=4}
plots_ext_slDriv <- test_ext_cm %>% 
  mutate(value = impacts_slope) %>%
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Slopes"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      ySub   <- "SLR Impact Slopes"
      ## Filter data
      # data_i <- data_x
      data_i <- data_x %>% filter(sector==sector_i)
      data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      list_i %>% print
      # list_i[c("breaks", "labels")] %>% lapply(function(y){length(y)}) %>% unlist %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=driverValue_ref, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
plots_ext_slDriv
```






#### GCM Functions

Check GCM impact functions:

```{r test_impactVals1}
test_impactVals1 <- -1:20
```


Regions


```{r test_co_regions}
test_co_regions <- test_systemData$co_regions; test_co_regions
```


Examine model types

```{r}
test_systemData$co_models %>% glimpse
test_systemData$co_modelTypes %>% glimpse
```



Model types

```{r test_co_models}
test_co_models  <- test_systemData$co_models %>% select(c("model_dot", "modelType")); test_co_models %>% glimpse
test_models_dot <- (test_co_models %>% filter(modelType %in% c("gcm")))$model_dot; test_models_dot
test_gcm_impact <- test_systemData$list_impactFunctions[1:1e3]; test_gcm_impact %>% head %>% names
test_gcm_names  <- test_gcm_impact %>% names; test_gcm_names %>% head
# test_gcm_names[30:60]
```


* GISS-E2-R defined up to 3 degrees of warming: Should have NA values for values above 3 degrees
* GFDL-CM3 defined up to 6 degrees of warming: : Should have same values for values 10C and above

```{r test_gcm_impacts}
# test_gcm_impact[["ATSExtremeTemp_high_CI_NA_NA_gcm_CCSM4_Northeast"]](-1)
### function(str_x, vals_x=test_impactVals1, data_x=test_gcm_impact, models_x=test_models_dot)
test_gcm_impacts <- test_co_regions$region_dot %>% lapply(function(region_j){
  df_j <- test_models_dot  %>% lapply(function(
    model_i, 
    sector_i = "ATSExtremeTemp",
    variant_i = "high_CI",
    impType_i = "NA",
    impYear_i = "NA"){
    ### String
    str_x    <- paste(sector_i, variant_i, impType_i, impYear_i, "gcm", sep="_"); 
    ### Region and name
    region_i <- region_j
    name_i   <- paste(str_x, model_i, region_i, sep="_"); 
    check_i  <- (name_i %in% test_gcm_names)
    
    # paste0(name_i, ": ", check_i) %>% print
    df_i     <- data.frame(driverValue   = test_impactVals1, scaled_impacts = NA)
    df_i     <- df_i %>% mutate(model_id = model_i)
    df_i     <- df_i %>% mutate(region   = region_i)
    df_i     <- df_i %>% mutate(func_id  = str_x)
    df_i     <- df_i %>% mutate(scaled_impacts = NA)
    str_x="ATSExtremeTemp_high_CI_NA_NA_gcm"
    if(check_i){
      fun_i  <- test_gcm_impact[[name_i]]
      vals_i <- fun_i(df_i$driverValue)
      df_i   <- df_i %>% mutate(scaled_impacts = vals_i)
    }
    return(df_i)
  }) %>% (function(df_i){do.call(rbind, df_i)})
}) %>% (function(df_j){do.call(rbind, df_j)})

test_gcm_impacts %>% glimpse
```


View Impacts

```{r, fig.height=5, fig.width=9}
test_gcm_impacts %>% 
  mutate(scaled_impacts = scaled_impacts %>% round(6)) %>%
  ggplot() + 
  geom_line(aes(x=driverValue, y =scaled_impacts, color = region)) + facet_grid(.~model_id) +
  # geom_line(aes(x=driverValue, y =scaled_impacts, color = model_id)) + facet_grid(.~region) + 
  scale_y_continuous(breaks = seq(0, 5, by=1)*5e-4, labels = (seq(0, 5, by=1)*5e-4) %>% as.character) +
  theme(legend.position = "bottom")
```






If above works, overwrite previous config

```{r save and overwrite data}
### Uncomment following two lines to create and save data and check the outputs
time1           <- Sys.time()
test_systemData <- createSystemData(save=T, excelName = excelFileName, outPath = sysArchName)
test_systemData <- createSystemData(save=T, excelName = excelFileName, silent=T)
time2           <- Sys.time()
time_create     <- time2 - time1; time_create
```







**Manually update the sysdata.rda file in the Rtool.**

After copying and pasting the system data to the Rtool, try detaching the package and then loading the package functions. 

```{r file.copy}
file.copy(
  from = dataOutPath %>% file.path(sysFileName) %>% paste0(".rda"),
  to   = frediPath   %>% file.path("R", sysFileName) %>% paste0(".rda"),
  overwrite = T
)
```


## Update Data

If tests pass, update the data

```{r test_systemData0}
codeNames; for(i in codeNames){ source(paste(codePath, i, sep="/")) }
frediPath %>% load_all
### Uncomment following two lines to create and save data and check the outputs
time1           <- Sys.time()
test_systemData <- createSystemData(save=T, excelName = excelFileName, silent=T)
time2           <- Sys.time()
time_create     <- time2 - time1; time_create
```

Then copy and paste the data to the tool

```{r copy sysdata}
file.copy(
  from = sysUseName,
  to   = frediPath %>% file.path("R", sysFileName) %>% paste0(".", "rda"),
  overwrite = TRUE
)
```


## Test R Tool

Change the following code if there are new sectors

```{r new_sectors}
# c_sectorsList <- FrEDI::get_sectorInfo()
c_sectorsList <- c("ATS Extreme Temperature", "Rail", "Coastal Properties")
```


Test inputs

```{r testInputs}
### Values above maximum values
testInputs <- list(
  ramp = list(
    tempInput = data.frame( year = 2000:2300, temp_C = seq(-1, 20, length.out=301)),
    slrInput  = data.frame( year = 2000:2300, slr_cm = seq(0, 270, length.out=301))
  )
)
```





Try running the function

```{r test FrEDI function, message=T}
### Results are fine for ATS Extreme Temperature and Coastal Properties
frediPath %>% load_all
# test1 <- testInputs$max %>% run_fredi(sectorList = c_sectorsList, aggLevels="all")
# test1 <- testInputs$ramp %>% run_fredi(sectorList = c_sectorsList, aggLevels="none")
# test1 <- testInputs$ramp %>% run_fredi(sectorList = c_sectorsList, aggLevels="none", thru2300=T)
time3 <- Sys.time()
test1 <- testInputs$ramp %>% run_fredi(sectorList = c_sectorsList, aggLevels="none", maxYear=2200)
time4 <- Sys.time(); time4 - time3
test1 <- test1 %>% mutate(driverValue2 = driverValue %>% round(0))
test1 %>% glimpse
# test1 <- test1 %>% aggregate_impacts(aggLevels = "all")
test1$driverUnit %>% unique
```



First checks: There are more NA values than non NA values

52143 16044
[1] 68187     0
[1] 4011    0

```{r}
test1$annual_impacts %>% (function(x){c(length(which(!is.na(x))), length(which(is.na(x))))})
test1$annual_impacts %>% (function(x){c(length(which(!is.nan(x))), length(which(is.nan(x))))})
(test1 %>% filter(driverUnit=="cm"))$annual_impacts %>% (function(x){c(length(which(!is.na(x))), length(which(is.na(x))))})

test1_na <- test1 %>% filter(is.na(annual_impacts))
test1_na %>% glimpse

test1_na$sector %>% unique
test1_na$year %>% range
```


Examine missing values

```{r test1_na}
(test1 %>% filter(driverUnit=="cm"))$year %>% range
(test1 %>% filter(driverUnit=="cm"))$year %>% range
test1_na <- test1 %>% filter(is.na(annual_impacts))
test1_na %>% glimpse
test1_na$sector %>% unique
test1_na_sum <- test1_na %>% mutate(n=1) %>% 
  group_by_at(.vars=c("sector", "variant", "impactYear", "impactType", "region", "model", "driverValue2")) %>% 
  summarize_at(.vars=c("n"), sum) %>% ungroup
test1_na_sum %>% glimpse
```



Try plotting

```{r test1 gcm, fig.width=8, fig.height=5}
test1 %>% 
  filter(driverUnit!="cm") %>% 
  ggplot() + 
  geom_line(aes(x=year, y=annual_impacts, color=region, group=interaction(impactType, variant, impactYear, model, region)), alpha = 0.4) + 
  facet_grid(sector~model) + 
  theme(legend.position="bottom", axis.text.x = element_text(angle=90))
```



SLR

Check missing values

```{r slr_check}
slr_check <- test1 %>% filter(driverUnit=="cm") %>% filter(is.na(annual_impacts))
slr_check %>% glimpse
```


Look at results

```{r slr test plots, fig.width=8, fig.height=5}
test1 %>% 
  filter(driverUnit=="cm") %>% 
  ggplot() + 
  geom_line(aes(x=year, y=annual_impacts, color=region, group=interaction(impactType, variant, impactYear, model, region)), alpha = 0.4) + 
  facet_grid(sector~region) + 
  theme(legend.position="bottom", axis.text.x = element_text(angle=90))
```



Test ramp function






```{r test_slr0}
# test_Inputs
test_slr0 <- testInputs$ramp$slrInput; test_slr0 %>% glimpse
# test_slr1 <- test_systemData$slrExtremes; test_slr1 %>% glimpse
test_slr2 <- test_slr0 %>% left_join(test_slr1, by=c("year")) %>% arrange_at(.vars=c("sector", "variant", "impactType", "impactYear", "region", "year")); test_slr2 %>% glimpse
test_slr3 <- test_slr2 %>% mutate(impact = impacts_intercept + impacts_slope * driverValue_ref); test_slr3 %>% glimpse
```







Visual check of impacts

```{r test_plots_imp, fig.width=6, fig.height=4}
test_plots_imp <- test_slr3 %>% 
  mutate(impact = impacts_intercept + impacts_slope * (slr_cm - driverValue_ref)) %>% 
  mutate(value = impact) %>%
  filter(year %in% seq(2000, 2300, by=10)) %>%
  (function(data_x, title = "SLR Impact Values"){
    sectors_x <- data_x$sector %>% unique
    list_x    <- sectors_x %>% lapply(function(sector_i){
      # ySub   <- "SLR Impact Slopes"
      ## Filter data
      # data_i <- data_x
      data_i <- data_x %>% filter(sector==sector_i)
      data_i$value %>% range %>% print
      # data_i <- data_i %>% mutate(variant=variant %>% as.character)
      # var_i  <- data_i$variant %>% unique; var_i %>% print
      ### Get breaks
      list_i <- data_i$value %>% get_plotBreaks
      list_i %>% print
      # list_i[c("breaks", "labels")] %>% lapply(function(y){length(y)}) %>% unlist %>% print
      ### Adjust data
      rnd_i  <- list_i$div %>% log10 %>% abs
      # data_i <- data_i %>% mutate(value=value/list_i$div)
      # data_i <- data_i %>% mutate(value=value %>% round(rnd_i))
      #### Plot data
      plot_i <- data_i %>% ggplot() + geom_line(aes(x=year, y=value, group=interaction(impactType, variant, region), color = region, linetype=impactType), alpha = 0.4) +
        facet_grid(.~region)
      plot_i <- plot_i + theme(legend.position = "bottom") + theme(axis.text.x = element_text(angle=90))
      plot_i <- plot_i + ggtitle(title)
      # plot_i <- plot_i + scale_y_continuous(list_i$yLab, limits=list_i$limits, breaks = list_i$breaks, labels=list_i$labels)
      return(plot_i)
    })
    names(list_x) <- sectors_x
    return(list_x)
  })
test_plots_imp
```




```{r test2}
frediPath %>% load_all
test2 <- testInputs$ramp %>% run_fredi(aggLevels="none")
```




Try the package: 167,184 rows

```{r df_defaults, message=T}
frediPath %>% load_all
df_defaults <- run_fredi(sectorList = NULL, aggLevels=c("national", "modelaverage", "impactyear")) %>% filter(year %in% seq(2010, 2300, by=5)) 
# df_defaults <- run_fredi(sectorList = c_sectorsList, aggLevels=c("national", "modelaverage", "impactyear")) %>% filter(year %in% seq(2010, 2300, by=5)) 
# df_defaults <- FrEDI::run_fredi(sectorList = c_sectorsList, aggLevels="none") %>% filter(year %in% seq(2010, 2090, by=5))
df_defaults %>% filter(sector=="ATS Extreme Temperature") %>% filter(region=="National Total") %>% filter(year==2090) %>% filter(model=="Average")
df_defaults %>% dim
df_defaults %>% filter(!is.na(annual_impacts)) %>% nrow
(df_defaults %>% filter(!is.na(annual_impacts)))$annual_impacts %>% range
(df_defaults %>% filter(!is.na(annual_impacts)))$sector %>% unique
```



Examine rounding

```{r}
# Extreme Temperature, No Adaptation, 2090 socioeconomics, Cold, Midwest, CanESM2, 2070
# sprintf(x, fmt = '%#.3f') 
test_digits <- df_defaults %>%
  filter(year == 2070, region == "Midwest", model == "CanESM2") %>%
  filter(sector == "Extreme Temperature", variant == "No Adaptation") %>% 
  filter(impactYear == "2090", impactType == "Cold") %>% 
  select(annual_impacts) %>% as.vector; test_digits

# test_digits %>% format(digits = 6)
# test_digits %>% sprintf(fmt = '%#.6f') 
# c(NA) %>% sprintf(fmt = '%#.6f') 
### -239115535.389834
```


Use the following code to save the results:

* Name the output path and create it if it doesn't exist.
* Then save the outputs file.


```{r saveOutputsPath}
saveOutputsPath <- frediPath %>% file.path("..", "analysis", "qc", today)
if(!dir.exists(saveOutputsPath)){saveOutputsPath %>% dir.create}
test1 %>% write.csv(file = file.path(saveOutputsPath, paste0(today, "_qc_outputs.csv")), row.names=F, na="")
```






Create plots



```{r plot types, fig.height=10, fig.width=16}
### Create only heatmaps
# frediPath %>% paste("R", sep="/") %>% load_all()
# defPlots <- df_defaults %>% get_plots(plotTypes="heatmaps")
defPlots <- df_defaults %>% get_plots(plotTypes="heatmaps")
defPlots$heatmaps$SLR
```






